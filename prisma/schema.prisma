generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  COMERCIAL
  PRODUCAO
  GESTAO
  ADMIN
}

enum OrigemLead {
  INDICACAO
  INSTAGRAM
  ARQUITETO
  FACEBOOK
  SITE
  AMIGO
  FAMILIAR
  PARCEIRO
}

enum TipoAtividadeLead {
  LIGACAO
  EMAIL_ENVIADO
  ORCAMENTO_ENVIADO
  CONTATO_WHATSAPP
  OBSERVACAO
}

enum StatusLead {
  LEAD
  ORCAMENTO_ENVIADO
  CONTRATO_ASSINADO
  PERDIDO
}

enum StatusProducao {
  AGUARDANDO_ARQUIVOS
  PARA_CORTE
  MONTAGEM
  FITAGEM
  PAUSADO
  INSTALACAO
  ENTREGUE
}

enum TipoPagamento {
  ENTRADA
  FINAL
}

enum TipoArquivo {
  GCODE
  TRES_D
  PDF_CORTE
  CONTRATO
}

enum StatusSugestao {
  NOVA
  EM_DISCUSSAO
  APROVADA
  IMPLEMENTADA
  ARQUIVADA
}

model Usuario {
  id        String   @id @default(cuid())
  email     String   @unique
  senhaHash String
  nome      String
  role      Role
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  leadsCriados       Lead[]
  atividadesLead     LeadAtividade[]
  projetosCriados    Projeto[]       @relation("ProjetoCreatedBy")
  projetosAtualizados Projeto[]      @relation("ProjetoUpdatedBy")
  logsStatusProjeto  ProjetoStatusLog[]
  tokensRecuperacao  TokenRecuperacaoSenha[]
  sugestoes          SugestaoMelhoria[]
  pushSubscriptions  PushSubscription[]
}

// Push (Web Push) para notificações no PWA
model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      Usuario  @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

model Lead {
  id               String      @id @default(cuid())
  nome             String
  email            String?
  telefone         String
  origem           OrigemLead
  status           StatusLead  @default(LEAD)
  motivoPerda      String?
  descricaoProjeto String?
  observacoes      String?
  dataUltimoContato DateTime?
  linkOrcamento    String?
  linkProjeto3d    String?
  endereco         String?
  createdById      String?
  createdBy        Usuario?   @relation(fields: [createdById], references: [id])
  projetos         Projeto[]
  atividades       LeadAtividade[]
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([status])
  @@index([origem])
  @@index([createdAt])
  @@index([nome])
}

model LeadAtividade {
  id        String           @id @default(cuid())
  leadId    String
  lead      Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  tipo      TipoAtividadeLead
  descricao String?
  usuarioId String?
  usuario   Usuario?         @relation(fields: [usuarioId], references: [id])
  createdAt DateTime        @default(now())
}

model Projeto {
  id                        String          @id @default(cuid())
  leadId                    String?
  lead                      Lead?           @relation(fields: [leadId], references: [id])
  nome                      String
  statusProducao            StatusProducao  @default(AGUARDANDO_ARQUIVOS)
  valorTotal                Decimal         @db.Decimal(12, 2)
  valorEntradaPago          Decimal         @default(0) @db.Decimal(12, 2)
  valorPendente             Decimal         @db.Decimal(12, 2)
  dataPagamentoFinalPrevista DateTime?
  dataEntregaPrevista       DateTime?
  dataEntregaReal           DateTime?
  dataInicioProducao        DateTime?
  custoMateriais            Decimal?        @db.Decimal(12, 2)
  custoMaoObra              Decimal?        @db.Decimal(12, 2)
  margemPct                 Decimal?        @db.Decimal(5, 2)
  qtdChapasMdf              Int?
  observacoes               String?
  linkOrcamento             String?
  linkProjeto3d             String?
  idPlanilhaProducao        String?  // ID da planilha Produção para vincular Financeiro
  createdById               String?
  createdBy                 Usuario?        @relation("ProjetoCreatedBy", fields: [createdById], references: [id])
  updatedById               String?
  updatedBy                 Usuario?        @relation("ProjetoUpdatedBy", fields: [updatedById], references: [id])
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  pagamentos                Pagamento[]
  arquivos                  Arquivo[]
  checklistCompras          ChecklistCompras?
  materiais                 MaterialProjeto[]
  logsStatus                ProjetoStatusLog[]
  movimentacoesCaixa        MovimentacaoCaixa[]
  sugestoes                 SugestaoMelhoria[]

  @@index([statusProducao])
  @@index([updatedAt])
  @@index([leadId])
  @@index([createdAt])
}

model MaterialProjeto {
  id          String   @id @default(cuid())
  projetoId   String
  projeto     Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  descricao   String
  quantidade  Int?     @default(1)
  ordem       Int?
  createdAt   DateTime @default(now())
}

model SugestaoMelhoria {
  id        String        @id @default(cuid())
  texto     String
  etapa     String?       // etapa da produção ou contexto (ex: Montagem, Corte)
  usuarioId String
  usuario   Usuario       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  projetoId String?
  projeto   Projeto?      @relation(fields: [projetoId], references: [id], onDelete: SetNull)
  status    StatusSugestao @default(NOVA)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model ProjetoStatusLog {
  id         String        @id @default(cuid())
  projetoId  String
  projeto    Projeto       @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  deStatus   StatusProducao
  paraStatus StatusProducao
  usuarioId  String?
  usuario    Usuario?      @relation(fields: [usuarioId], references: [id])
  createdAt  DateTime      @default(now())
}

model Pagamento {
  id              String        @id @default(cuid())
  projetoId       String
  projeto         Projeto       @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  valor           Decimal       @db.Decimal(12, 2)
  tipo            TipoPagamento
  data            DateTime?
  dataVencimento  DateTime?
  observacao      String?
  linkComprovante String?
  createdAt       DateTime      @default(now())
}

model Arquivo {
  id           String     @id @default(cuid())
  projetoId    String
  projeto      Projeto    @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  tipo         TipoArquivo
  nomeOriginal String
  caminho      String
  createdAt    DateTime   @default(now())
}

model ChecklistCompras {
  id                  String   @id @default(cuid())
  projetoId           String   @unique
  projeto             Projeto  @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  chapasCompradas     Boolean  @default(false)
  ferragensCompradas  Boolean  @default(false)
  outrosItens         String?
  updatedAt           DateTime @updatedAt
}

model ItemEstoqueAlerta {
  id               String   @id @default(cuid())
  nome             String
  quantidadeMinima Int
  quantidadeAtual  Int      @default(0)
  avisoAtivo       Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model TokenRecuperacaoSenha {
  id        String   @id @default(cuid())
  usuarioId String
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiraEm  DateTime
  createdAt DateTime @default(now())
}

// Fluxo de caixa (intermediário: entradas/saídas, contas a pagar, previsão)
enum TipoMovimentacaoCaixa {
  ENTRADA
  SAIDA
}

enum StatusMovimentacaoCaixa {
  PREVISTO
  PAGO
}

enum CategoriaDespesa {
  SALARIO
  CONTAS_FIXAS
  FORNECEDORES
  INVESTIMENTO_EQUIPAMENTO
  INVESTIMENTO_APLICACAO
  IMPOSTOS
  OUTROS
}

model MovimentacaoCaixa {
  id                String                   @id @default(cuid())
  tipo              TipoMovimentacaoCaixa
  valor             Decimal                  @db.Decimal(12, 2)
  data              DateTime
  dataVencimento    DateTime?
  dataPagamento     DateTime?
  categoria         CategoriaDespesa?
  descricao         String
  referenciaSalario String?
  status            StatusMovimentacaoCaixa  @default(PREVISTO)
  projetoId         String?
  projeto           Projeto?                 @relation(fields: [projetoId], references: [id], onDelete: SetNull)
  createdAt         DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt

  @@index([tipo, status, data])
  @@index([data])
  @@index([status])
}

// Dados institucionais (único registro: CNPJ, endereço, telefone, site, Instagram)
model DadosInstitucionais {
  id        String   @id @default(cuid())
  cnpj      String?
  endereco  String?
  telefone  String?
  site      String?
  instagram String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Credenciais e acessos (senha criptografada; só ADMIN)
model CredencialAcesso {
  id                  String   @id @default(cuid())
  categoria           String
  servico             String
  login               String?
  senhaCriptografada  String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Telefones úteis (fornecedores, parceiros)
model ContatoUtil {
  id        String   @id @default(cuid())
  nome      String
  telefone  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
